@page "/register"
@rendermode InteractiveServer
@using MyMuscleCars.Models
@using System.ComponentModel.DataAnnotations
@using System.Text.Json.Serialization;
@inject ILogger<Register> Logger
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS


<PageTitle>CSE Muscle Cars - Register</PageTitle>

  <main>
    <article>
      <!-- 
        - #REGISTRATION SECTION
      -->
      <section class="section registration" aria-labelledby="registration-label">
        <div class="container">

          <p class="section-subtitle :light" id="registration-label">Join Our Community</p>

          <h2 class="h2 section-title">Create Your Account</h2>

          <div class="registration-container">
            <div class="registration-form-container">
                        <EditForm Model="@RegisterModel"
                                  OnValidSubmit="HandleSubmit"
                                  OnInvalidSubmit="HandleInvalidSubmit"
                                  FormName="RegisterForm"
                                  class="registration-form">
                            <DataAnnotationsValidator />

                            <!-- First Name -->
                            <div class="form-group">
                                <label for="firstName" class="form-label">First Name</label>
                                <InputText id="firstName"
                                           class="form-input"
                                           @bind-Value="RegisterModel!.FirstName"
                                           placeholder="Enter your first name" />
                                <ValidationMessage For="@(() => RegisterModel!.FirstName)" />
                            </div>

                            <!-- Last Name -->
                            <div class="form-group">
                                <label for="lastName" class="form-label">Last Name</label>
                                <InputText id="lastName"
                                           class="form-input"
                                           @bind-Value="RegisterModel!.LastName"
                                           placeholder="Enter your last name" />
                                <ValidationMessage For="@(() => RegisterModel!.LastName)" />
                            </div>

                            <!-- Email -->
                            <div class="form-group">
                                <label for="email" class="form-label">Email Address</label>
                                <InputText id="email"
                                           class="form-input"
                                           @bind-Value="RegisterModel!.Email"
                                           placeholder="Enter your email" />
                                <ValidationMessage For="@(() => RegisterModel!.Email)" />
                            </div>

                            <!-- Password -->
                            <div class="form-group">
                                <label for="password" class="form-label">Password</label>
                                <InputText id="password"
                                           class="form-input"
                                           @bind-Value="RegisterModel!.Password"
                                           placeholder="Create a secure password"
                                           type="password" />
                                <ValidationMessage For="@(() => RegisterModel!.Password)" />
                            </div>

                            <!-- Confirm Password -->
                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <InputText id="confirmPassword"
                                           class="form-input"
                                           @bind-Value="RegisterModel!.ConfirmPassword"
                                           placeholder="Confirm your password"
                                           type="password" />
                                <ValidationMessage For="@(() => RegisterModel!.ConfirmPassword)" />
                            </div>

                            <!-- Error / Success Messages -->
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="error-message">
                                    <i class="ri-error-warning-line"></i> @errorMessage
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="success-message">
                                    <i class="ri-check-line"></i> @successMessage
                                </div>
                            }

                            <!-- Submit Button -->
                            <button type="submit" class="btn registration-btn" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="loading-spinner"></span>
                                    <span>Creating Account...</span>
                                }
                                else
                                {
                                    <span>Create Account</span>
                                    <span class="material-symbols-rounded">arrow_forward</span>
                                } 
                            </button>
                        </EditForm>

                        <div class="registration-footer">
                            <p>Already have an account? <a href="/login" class="btn-link">Sign In</a></p>
                        </div>
                        </div>

                            <div class="registration-info">
              <div class="info-card">
                <figure class="info-icon">
                  <img src="images/services-1.png" width="80" height="80" loading="lazy" alt="Car Purchase">
                </figure>
                <h3 class="h3 info-title">Purchase Cars</h3>
                <p class="info-text">
                  Browse and purchase from our collection of premium muscle cars including Chevrolet, Ford, and Dodge
                  models.
                </p>
              </div>

              <div class="info-card">
                <figure class="info-icon">
                  <img src="images/services-2.png" width="80" height="80" loading="lazy" alt="Repair Services">
                </figure>
                <h3 class="h3 info-title">Repair Services</h3>
                <p class="info-text">
                  Access our professional repair and maintenance services with expert mechanics and engineers.
                </p>
              </div>

              <div class="info-card">
                <figure class="info-icon">
                  <img src="images/services-3.png" width="80" height="80" loading="lazy" alt="Warranty">
                </figure>
                <h3 class="h3 info-title">12-Month Warranty</h3>
                <p class="info-text">
                  All our cars come with a comprehensive 12-month warranty for your peace of mind.
                </p>
              </div>
            </div>

          </div>

        </div>
      </section>

    </article>
  </main>

@code {
    [SupplyParameterFromForm]
    private RegistrationModel? RegisterModel { get; set; }

    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private string? _pendingToken = null;
    private bool _pendingRedirect = false;
    private bool _browserRendered = false;

    protected override void OnInitialized()
    {
        Logger.LogInformation("üîπ Register component initialized");
        RegisterModel ??= new();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        Logger.LogInformation("üîπ OnAfterRenderAsync triggered. firstRender={FirstRender}, pendingToken={Token}", firstRender, _pendingToken);

        if (firstRender)
        {
            _browserRendered = true;
            Logger.LogInformation("üîπ First render complete, browserRendered set to true");
        }

        // If we need to redirect after server sets the auth cookie, do it now when browser is ready.
        if (_browserRendered)
        {
            if (_pendingRedirect)
            {
                _pendingRedirect = false;
                Logger.LogInformation("‚û° Redirecting to homepage from OnAfterRenderAsync...");
                Navigation.NavigateTo("/");
            }
            return Task.CompletedTask;
        }
        else
        {
            Logger.LogInformation("‚è≥ Skipping token storage. _browserRendered={BrowserRendered}, _pendingToken={Token}", _browserRendered, _pendingToken);
        }
        return Task.CompletedTask;
    }

    private void HandleInvalidSubmit(EditContext ctx)
    {
        errorMessage = "Please fix the highlighted errors.";
        Logger.LogWarning("‚ùå Invalid submit triggered: {Errors}", string.Join(", ", ctx.GetValidationMessages()));
    }

    private async Task HandleSubmit()
    {
        Logger.LogInformation("üìù HandleSubmit triggered");
        errorMessage = string.Empty;
        successMessage = string.Empty;
        isLoading = true;

        try
        {
            if (RegisterModel?.Password != RegisterModel?.ConfirmPassword)
            {
                errorMessage = "Passwords do not match.";
                Logger.LogWarning("‚ùå Password mismatch");
                return;
            }

            Logger.LogInformation("üì° Sending POST request to /api/register via browser fetch (to allow Set-Cookie)");
            var jsResult = await MyMuscleCars.Services.JsInteropHelpers.PostJson(JS, "/api/register", RegisterModel!);

            if (jsResult?.Status == 200)
            {
                successMessage = "Account created successfully! Redirecting...";
                Logger.LogInformation("‚úÖ Registration succeeded (browser fetch)");

                if (_browserRendered)
                {
                    Navigation.NavigateTo("/", forceLoad: true);
                    return;
                }
                else
                {
                    _pendingRedirect = true;
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                var error = jsResult?.Body ?? "Unknown error";
                errorMessage = $"Server error: {error}";
                Logger.LogError("‚ùå Server error (browser fetch): {Error}", error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
            Logger.LogError("‚ùå Exception in HandleSubmit: {Message}", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    public class RegisterResult
    {
        [JsonPropertyName("token")]
        public string Token { get; set; } = string.Empty;

        [JsonPropertyName("user")]
        public string User { get; set; } = string.Empty;
    }

    private class BrowserPostResult
    {
        public int Status { get; set; }
        public string? Body { get; set; }
    }
}
